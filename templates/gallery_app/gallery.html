{% extends "base.html" %}
{% load static %}

{% block content %}
<section class="py-12">
  <div class="container mx-auto px-4">

    <div class="text-center mb-10" data-aos="fade-up">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Галерея</h1>
      <p class="text-gray-600 max-w-2xl mx-auto mt-3">
        Будни компании, обучение персонала, корпоративные мероприятия и рабочие совещания
      </p>
    </div>

    <form method="get" class="flex flex-wrap items-center gap-3 mb-8">
      <label class="text-sm text-gray-600">Год:</label>
      <select name="year" class="border rounded px-3 py-2" onchange="this.form.submit()">
        <option value="">Все</option>
        {% for y in years %}
          <option value="{{ y }}" {% if selected_year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>

      <label class="text-sm text-gray-600">Проект:</label>
      <select name="project" class="border rounded px-3 py-2" onchange="this.form.submit()">
        <option value="">Все</option>
        {% for p in projects %}
          <option value="{{ p }}" {% if selected_project == p %}selected{% endif %}>{{ p }}</option>
        {% endfor %}
      </select>
      {% if selected_year or selected_project %}
        <a href="{% url 'gallery:gallery' %}" class="text-sm text-blue-600 hover:underline">Сбросить</a>
      {% endif %}
    </form>

    {% for item in categories_data %}
      {% with cat=item.category page=item.page_obj param=item.page_param %}

      <div class="mb-16" id="{{ cat.slug }}">
        <h2 class="text-2xl font-semibold mb-6">{{ cat.title }}</h2>

        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-7 gap-4">
          {% for img in page %}
            <button onclick="openGalleryModal({{ forloop.counter0 }}, '{{ cat.slug }}')"
                    class="group overflow-hidden rounded-lg bg-gray-100">
              <img src="{{ img.image.url }}"
                   alt="Фото"
                   class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105"
                   loading="lazy" />
            </button>
          {% empty %}
            <div class="col-span-full text-center text-gray-500">
              Пока нет фотографий в этой категории
            </div>
          {% endfor %}
        </div>

        {% if page.paginator.num_pages > 1 %}
         <div class="flex justify-center gap-2 mt-6">
          {% if page.has_previous %}
          <a
            hx-get="?{{ item.page_param }}={{ page.previous_page_number }}{% if selected_year %}&year={{ selected_year }}{% endif %}{% if selected_project %}&project={{ selected_project|urlencode }}{% endif %}"
            hx-target="#{{ cat.slug }}"
            hx-select="#{{ cat.slug }}"
            hx-swap="outerHTML"
            hx-push-url="true"
            data-scroll-id="{{ cat.slug }}"
            class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >←</a>
        {% endif %}
        
        {% if page.has_next %}
          <a
            hx-get="?{{ item.page_param }}={{ page.next_page_number }}{% if selected_year %}&year={{ selected_year }}{% endif %}{% if selected_project %}&project={{ selected_project|urlencode }}{% endif %}"
            hx-target="#{{ cat.slug }}"
            hx-select="#{{ cat.slug }}"
            hx-swap="outerHTML"
            hx-push-url="true"
            data-scroll-id="{{ cat.slug }}"
            class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
          >→</a>
        {% endif %}
        </div>
        {% endif %}
      </div>

      {% endwith %}
    {% endfor %}

  </div>
</section>

<!-- МОДАЛКА -->
<div id="galleryModal"
     class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center">

  <button onclick="closeGalleryModal()"
          class="absolute top-6 right-6 text-white text-3xl">✕</button>

  <button onclick="prevImage()"
          class="absolute left-4 md:left-10 text-white text-4xl">‹</button>

  <img id="galleryModalImg"
       class="max-h-[85vh] max-w-[90vw] object-contain rounded-lg" alt="">

  <button onclick="nextImage()"
          class="absolute right-4 md:right-10 text-white text-4xl">›</button>

  <div id="galleryCounter"
       class="absolute bottom-6 text-white text-sm opacity-80"></div>
</div>

<!-- JS -->
<script>
  // Собираем все картинки по категориям из БД
  const images = {
    {% for item in categories_data %}
      "{{ item.category.slug }}": [
        {% for img in item.page_obj %}
          "{{ img.image.url|escapejs }}",
        {% endfor %}
      ],
    {% endfor %}
  };

  let currentIndex = 0;
  let currentGroup = null;

  function openGalleryModal(index, group) {
    currentGroup = group;
    currentIndex = index;

    if (!images[currentGroup] || images[currentGroup].length === 0) return;

    updateModal();
    document.getElementById("galleryModal").classList.remove("hidden");
    document.documentElement.style.overflow = "hidden";
  }

  function closeGalleryModal() {
    document.getElementById("galleryModal").classList.add("hidden");
    document.documentElement.style.overflow = "";
  }

  function updateModal() {
    const list = images[currentGroup] || [];
    const img = list[currentIndex];

    document.getElementById("galleryModalImg").src = img;
    document.getElementById("galleryCounter").innerText =
      `${currentIndex + 1} / ${list.length}`;
  }

  function nextImage() {
    const list = images[currentGroup] || [];
    if (currentIndex < list.length - 1) {
      currentIndex++;
      updateModal();
    }
  }

  function prevImage() {
    if (currentIndex > 0) {
      currentIndex--;
      updateModal();
    }
  }

  // Закрытие по ESC
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeGalleryModal();
    if (e.key === "ArrowRight") nextImage();
    if (e.key === "ArrowLeft") prevImage();
  });

  // SWIPE
  let startX = 0;
  const modal = document.getElementById("galleryModal");

  modal.addEventListener("touchstart", (e) => {
    startX = e.touches[0].clientX;
  });

  modal.addEventListener("touchend", (e) => {
    const diff = startX - e.changedTouches[0].clientX;
    if (diff > 50) nextImage();
    if (diff < -50) prevImage();
  });

  modal.addEventListener("click", (e) => {
    if (e.target.id === "galleryModal") closeGalleryModal();
  });

  window.addEventListener("load", () => {
    document.querySelectorAll(".gallery-skeleton").forEach(el => el.classList.add("hidden"));
    document.querySelectorAll(".gallery-grid").forEach(el => el.classList.remove("hidden"));
  });
</script>
<script>
  document.body.addEventListener("htmx:afterSwap", (e) => {
    // реагируем только если обновляли категорию галереи
    const target = e.target;
    if (!target || !target.id) return;

    // мягкий скролл к началу блока
    target.scrollIntoView({ behavior: "smooth", block: "start" });
  });
</script>
<style>
  /* лёгкая анимация на время подмены */
  .htmx-swapping { opacity: 0; transition: opacity .15s ease; }
  .htmx-settling { opacity: 1; transition: opacity .15s ease; }
</style>
{% endblock %}
